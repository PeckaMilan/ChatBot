<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Portal - ChatBot Platform</title>
    <style>
        /* ─── Design System ─── */
        :root {
            --p-primary: #4f46e5;
            --p-primary-hover: #4338ca;
            --p-primary-light: #eef2ff;
            --p-success: #10b981;
            --p-success-light: #d1fae5;
            --p-warning: #f59e0b;
            --p-warning-light: #fef3c7;
            --p-danger: #ef4444;
            --p-danger-light: #fee2e2;
            --p-sidebar-w: 260px;
            --p-text: #1a202c;
            --p-text-sec: #4a5568;
            --p-text-muted: #a0aec0;
            --p-bg: #f7f8fc;
            --p-card: #ffffff;
            --p-border: #e2e8f0;
            --p-radius: 12px;
            --p-radius-sm: 8px;
            --p-shadow-sm: 0 1px 3px rgba(0,0,0,0.06);
            --p-shadow-md: 0 4px 12px rgba(0,0,0,0.08);
            --p-shadow-lg: 0 10px 40px rgba(0,0,0,0.12);
            --p-ease: cubic-bezier(0.4, 0, 0.2, 1);
            --p-font: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: var(--p-font);
            background: var(--p-bg);
            color: var(--p-text);
            min-height: 100vh;
            line-height: 1.5;
        }

        /* ─── Login ─── */
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 40px;
            background: var(--p-card);
            border-radius: var(--p-radius);
            box-shadow: var(--p-shadow-lg);
        }
        .login-container h1 {
            text-align: center;
            margin-bottom: 8px;
            color: var(--p-text);
            font-size: 24px;
        }
        .login-subtitle {
            text-align: center;
            color: var(--p-text-muted);
            margin-bottom: 32px;
            font-size: 14px;
        }
        .login-container.hidden { display: none; }

        /* ─── Forms ─── */
        .form-group { margin-bottom: 20px; }
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            font-size: 13px;
            color: var(--p-text-sec);
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px 14px;
            border: 1.5px solid var(--p-border);
            border-radius: var(--p-radius-sm);
            font-size: 14px;
            font-family: var(--p-font);
            color: var(--p-text);
            background: var(--p-card);
            transition: border-color 0.2s var(--p-ease), box-shadow 0.2s var(--p-ease);
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--p-primary);
            box-shadow: 0 0 0 3px rgba(79,70,229,0.12);
        }

        /* ─── Buttons ─── */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            font-family: var(--p-font);
            border: none;
            border-radius: var(--p-radius-sm);
            cursor: pointer;
            transition: all 0.15s var(--p-ease);
            width: 100%;
        }
        .btn:hover:not(:disabled) { transform: translateY(-1px); box-shadow: var(--p-shadow-sm); }
        .btn:active:not(:disabled) { transform: translateY(0); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-sm { padding: 7px 14px; font-size: 13px; width: auto; }

        .btn-primary, .btn { background: var(--p-primary); color: white; }
        .btn-primary:hover:not(:disabled) { background: var(--p-primary-hover); }
        .btn-secondary { background: var(--p-bg); color: var(--p-text-sec); border: 1.5px solid var(--p-border); }
        .btn-secondary:hover:not(:disabled) { background: var(--p-border); }
        .btn-danger { background: var(--p-danger); color: white; }
        .btn-danger:hover:not(:disabled) { background: #dc2626; }
        .btn-success { background: var(--p-success); color: white; }
        .btn-success:hover:not(:disabled) { background: #059669; }
        .btn-warning { background: var(--p-warning); color: white; }
        .btn-warning:hover:not(:disabled) { background: #d97706; }
        .btn-ghost { background: transparent; color: var(--p-text-sec); }
        .btn-ghost:hover:not(:disabled) { background: var(--p-bg); }

        .error { color: var(--p-danger); margin-top: 15px; text-align: center; font-size: 14px; }
        .success { color: var(--p-success); margin-top: 15px; text-align: center; font-size: 14px; }

        .spinner {
            display: inline-block; width: 14px; height: 14px;
            border: 2px solid var(--p-border); border-top-color: var(--p-primary);
            border-radius: 50%; animation: spin 0.8s linear infinite;
            margin-right: 8px; vertical-align: middle;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ─── App Layout ─── */
        .dashboard { display: none; }
        .dashboard.active { display: flex; min-height: 100vh; }

        /* ─── Sidebar ─── */
        .sidebar {
            width: var(--p-sidebar-w);
            background: linear-gradient(180deg, #1a1d23 0%, #2d3748 100%);
            color: #e2e8f0;
            display: flex;
            flex-direction: column;
            position: fixed;
            top: 0; left: 0; bottom: 0;
            z-index: 100;
            transition: transform 0.25s var(--p-ease);
        }
        .sidebar-brand {
            padding: 24px 20px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.08);
        }
        .sidebar-brand svg { width: 28px; height: 28px; fill: var(--p-primary); flex-shrink: 0; }
        .sidebar-brand span { font-size: 18px; font-weight: 700; letter-spacing: -0.02em; color: white; }
        .sidebar-nav { flex: 1; padding: 12px 0; overflow-y: auto; }
        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 11px 20px;
            color: #94a3b8;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            border-left: 3px solid transparent;
            transition: all 0.15s var(--p-ease);
            text-decoration: none;
        }
        .nav-item:hover { color: #e2e8f0; background: rgba(255,255,255,0.04); }
        .nav-item.active {
            color: white;
            background: rgba(255,255,255,0.08);
            border-left-color: var(--p-primary);
        }
        .nav-item svg { width: 20px; height: 20px; fill: currentColor; flex-shrink: 0; opacity: 0.7; }
        .nav-item.active svg { opacity: 1; }
        .sidebar-footer {
            padding: 16px 20px;
            border-top: 1px solid rgba(255,255,255,0.08);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .sidebar-footer .company-name { font-size: 13px; color: #94a3b8; }
        .sidebar-footer .logout-btn {
            padding: 8px 14px; background: rgba(239,68,68,0.15); color: #fca5a5;
            border: none; border-radius: 6px; cursor: pointer; font-size: 13px;
            font-weight: 500; transition: background 0.15s;
        }
        .sidebar-footer .logout-btn:hover { background: rgba(239,68,68,0.25); }
        .sidebar-overlay {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5);
            z-index: 99; backdrop-filter: blur(2px);
        }

        /* ─── Main Content ─── */
        .main-content {
            flex: 1;
            margin-left: var(--p-sidebar-w);
            min-height: 100vh;
            transition: margin-left 0.25s var(--p-ease);
        }
        .topbar {
            padding: 20px 32px;
            display: flex;
            align-items: center;
            gap: 16px;
            background: var(--p-card);
            border-bottom: 1px solid var(--p-border);
            position: sticky;
            top: 0;
            z-index: 50;
        }
        .topbar .page-title { font-size: 20px; font-weight: 700; color: var(--p-text); }
        .hamburger {
            display: none; background: none; border: none; font-size: 24px;
            cursor: pointer; color: var(--p-text); padding: 4px;
        }
        .content-area {
            padding: 28px 32px;
        }

        /* ─── Section Transitions ─── */
        .tab-content { display: none; animation: fadeSlideIn 0.2s var(--p-ease); }
        .tab-content.active { display: block; }
        @keyframes fadeSlideIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ─── Stat Cards ─── */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 28px;
        }
        .stat-card {
            background: var(--p-card);
            padding: 20px 24px;
            border-radius: var(--p-radius);
            box-shadow: var(--p-shadow-sm);
            border-left: 4px solid var(--p-primary);
            transition: transform 0.15s var(--p-ease), box-shadow 0.15s var(--p-ease);
        }
        .stat-card:hover { transform: translateY(-2px); box-shadow: var(--p-shadow-md); }
        .stat-card h3 {
            color: var(--p-text-muted);
            font-size: 12px; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.04em;
            margin-bottom: 8px;
        }
        .stat-card .value { font-size: 28px; font-weight: 700; color: var(--p-text); }
        .stat-card .sub { font-size: 13px; color: var(--p-text-muted); margin-top: 4px; }
        .stat-card.success { border-left-color: var(--p-success); }
        .stat-card.success .value { color: var(--p-success); }
        .stat-card.warning { border-left-color: var(--p-warning); }

        /* ─── Sections ─── */
        .section {
            background: var(--p-card);
            padding: 24px;
            border-radius: var(--p-radius);
            box-shadow: var(--p-shadow-sm);
            margin-bottom: 24px;
        }
        .section h2 {
            color: var(--p-text); font-size: 17px; font-weight: 700;
            margin-bottom: 20px; padding-bottom: 12px;
            border-bottom: 1px solid var(--p-border);
        }
        .section h3 { color: var(--p-text); margin: 20px 0 10px; font-size: 15px; }
        .section p { color: var(--p-text-sec); margin-bottom: 16px; line-height: 1.6; font-size: 14px; }

        /* ─── Lists ─── */
        .widget-list, .doc-list { list-style: none; }
        .widget-item, .doc-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px; border: 1px solid var(--p-border);
            border-radius: var(--p-radius-sm); margin-bottom: 10px;
            transition: background 0.15s var(--p-ease), box-shadow 0.15s var(--p-ease);
        }
        .widget-item:hover, .doc-item:hover { background: var(--p-bg); box-shadow: var(--p-shadow-sm); }
        .widget-info h4, .doc-info h4 { margin-bottom: 4px; color: var(--p-text); font-size: 15px; }
        .widget-info span, .doc-info span { font-size: 13px; color: var(--p-text-muted); }
        .widget-actions, .doc-actions { display: flex; gap: 8px; flex-wrap: wrap; }
        .widget-actions button, .doc-actions button {
            padding: 7px 14px; border: none; border-radius: 6px;
            cursor: pointer; font-size: 13px; font-weight: 500;
            transition: all 0.15s var(--p-ease);
        }

        /* ─── Usage Bars ─── */
        .usage-bar {
            height: 8px; background: var(--p-border);
            border-radius: 4px; overflow: hidden; margin-top: 8px;
        }
        .usage-bar-fill {
            height: 100%; border-radius: 4px;
            background: linear-gradient(90deg, var(--p-success), #34d399);
            transition: width 0.6s var(--p-ease);
        }
        .usage-bar-fill.warning { background: linear-gradient(90deg, #d97706, var(--p-warning)); }
        .usage-bar-fill.danger { background: linear-gradient(90deg, #dc2626, var(--p-danger)); }

        /* ─── Tier Badge ─── */
        .tier-badge {
            display: inline-block; padding: 3px 10px; border-radius: 20px;
            font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;
        }
        .tier-free { background: #f1f5f9; color: #64748b; }
        .tier-starter { background: var(--p-success-light); color: #065f46; }
        .tier-professional { background: var(--p-primary-light); color: var(--p-primary); }
        .tier-enterprise { background: #f5f3ff; color: #7c3aed; }

        /* ─── Upload Zone ─── */
        .upload-zone {
            border: 2px dashed var(--p-border); border-radius: var(--p-radius);
            padding: 40px; text-align: center; cursor: pointer;
            transition: all 0.2s var(--p-ease);
        }
        .upload-zone:hover { border-color: var(--p-primary); background: var(--p-primary-light); }
        .upload-zone.dragover { border-color: var(--p-primary); background: var(--p-primary-light); }
        .upload-zone input[type="file"] { display: none; }

        .inline-form { display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap; }
        .inline-form .form-group { flex: 1; margin-bottom: 0; min-width: 200px; }
        .inline-form .btn { width: auto; margin-top: 0; }

        /* ─── Status Badges ─── */
        .status-badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; }
        .status-ready { background: var(--p-success-light); color: #065f46; }
        .status-processing { background: var(--p-warning-light); color: #92400e; }
        .status-failed { background: var(--p-danger-light); color: #991b1b; }
        .status-pending { background: #f1f5f9; color: #64748b; }

        /* ─── Code Blocks ─── */
        .code-block {
            background: #1e1e2e; color: #cdd6f4; padding: 16px; border-radius: var(--p-radius-sm);
            font-family: 'SF Mono', 'Fira Code', Consolas, monospace; font-size: 13px;
            overflow-x: auto; white-space: pre-wrap; word-break: break-all; position: relative;
        }
        .code-block code { color: #cdd6f4; background: none; padding: 0; font-family: inherit; font-size: inherit; }
        .code-block .copy-btn {
            position: absolute; top: 8px; right: 8px; padding: 4px 12px;
            background: rgba(255,255,255,0.1); color: #94a3b8; border: none;
            border-radius: 4px; cursor: pointer; font-size: 12px; transition: background 0.15s;
        }
        .code-block .copy-btn:hover { background: rgba(255,255,255,0.2); color: white; }

        /* ─── Modals ─── */
        .modal {
            display: none; position: fixed; inset: 0;
            background: rgba(0,0,0,0.4); backdrop-filter: blur(4px);
            justify-content: center; align-items: center; z-index: 1000;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: var(--p-card); padding: 28px; border-radius: var(--p-radius);
            max-width: 700px; width: 90%; max-height: 90vh; overflow-y: auto;
            box-shadow: var(--p-shadow-lg);
            animation: modalIn 0.2s var(--p-ease);
        }
        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.95) translateY(8px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h2 { font-size: 18px; }
        .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--p-text-muted); padding: 4px; }
        .modal-close:hover { color: var(--p-text); }

        .secret-display {
            display: flex; align-items: center; gap: 10px; background: var(--p-bg);
            padding: 12px 16px; border-radius: var(--p-radius-sm); border: 1px solid var(--p-border);
        }
        .secret-display code { flex: 1; font-family: monospace; font-size: 14px; color: var(--p-text); }
        .secret-display .btn-sm { flex-shrink: 0; }

        .guardrail-example {
            background: var(--p-primary-light); border: 1px solid #c7d2fe;
            border-radius: var(--p-radius-sm); padding: 16px; margin-bottom: 16px;
        }
        .guardrail-example h4 { color: var(--p-primary); margin-bottom: 8px; }

        /* ─── Chat Preview ─── */
        .chat-preview-container { display: flex; gap: 24px; flex-wrap: wrap; }
        .chat-preview-settings { flex: 1; min-width: 300px; }
        .chat-preview-box {
            flex: 1; min-width: 350px; max-width: 450px;
            border: 1px solid var(--p-border); border-radius: var(--p-radius);
            overflow: hidden; display: flex; flex-direction: column; height: 500px;
        }
        .chat-header { color: white; padding: 16px; font-weight: 600; }
        .chat-messages { flex: 1; padding: 16px; overflow-y: auto; background: var(--p-bg); }
        .chat-message { margin-bottom: 12px; max-width: 80%; }
        .chat-message.user { margin-left: auto; text-align: right; }
        .chat-message .bubble {
            display: inline-block; padding: 10px 14px; border-radius: var(--p-radius-sm); text-align: left; font-size: 14px;
        }
        .chat-message.user .bubble { background: var(--p-primary); color: white; }
        .chat-message.assistant .bubble { background: var(--p-card); border: 1px solid var(--p-border); }
        .chat-message.assistant .bubble h2, .chat-message.assistant .bubble h3, .chat-message.assistant .bubble h4 {
            margin: 8px 0 4px; font-size: 1em; font-weight: 600;
        }
        .chat-message.assistant .bubble ul { margin: 4px 0; padding-left: 20px; }
        .chat-message.assistant .bubble li { margin: 2px 0; }
        .chat-input-area {
            padding: 16px; background: var(--p-card); border-top: 1px solid var(--p-border);
            display: flex; gap: 10px;
        }
        .chat-input-area input {
            flex: 1; padding: 10px 14px; border: 1px solid var(--p-border);
            border-radius: var(--p-radius-sm); font-size: 14px; font-family: var(--p-font);
        }
        .chat-input-area input:focus { outline: none; border-color: var(--p-primary); }
        .chat-input-area button {
            padding: 10px 20px; background: var(--p-primary); color: white;
            border: none; border-radius: var(--p-radius-sm); cursor: pointer; font-weight: 600;
        }

        /* ─── Alerts ─── */
        .alert { padding: 14px 16px; border-radius: var(--p-radius-sm); margin-bottom: 16px; font-size: 14px; }
        .alert-info { background: var(--p-primary-light); border: 1px solid #c7d2fe; color: #3730a3; }
        .alert-warning { background: var(--p-warning-light); border: 1px solid #fde68a; color: #92400e; }

        /* ─── Charts ─── */
        .chart-container {
            display: flex; align-items: flex-end; gap: 2px;
            height: 200px; padding: 10px 0; border-bottom: 2px solid var(--p-border); overflow-x: auto;
        }
        .chart-bar {
            flex: 1; min-width: 8px; max-width: 30px;
            background: linear-gradient(to top, var(--p-primary), #818cf8);
            border-radius: 4px 4px 0 0; transition: all 0.3s var(--p-ease);
            cursor: pointer; position: relative;
        }
        .chart-bar:hover { background: linear-gradient(to top, var(--p-primary-hover), var(--p-primary)); }
        .chart-bar:hover::after {
            content: attr(data-tooltip);
            position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
            background: var(--p-text); color: white; padding: 4px 10px;
            border-radius: 6px; font-size: 12px; white-space: nowrap; z-index: 10;
        }
        .chart-labels { display: flex; justify-content: space-between; font-size: 12px; color: var(--p-text-muted); margin-top: 8px; }
        .chart-loading { display: flex; align-items: center; justify-content: center; width: 100%; color: var(--p-text-muted); }
        .period-selector { display: flex; gap: 4px; }
        .period-btn { padding: 6px 12px !important; border-radius: 6px !important; }
        .period-btn.active { background: var(--p-primary) !important; color: white !important; }

        /* ─── Widget Performance ─── */
        .widget-perf-item { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
        .widget-perf-name { width: 120px; font-size: 13px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: var(--p-text-sec); }
        .widget-perf-bar-container { flex: 1; height: 24px; background: var(--p-border); border-radius: 6px; overflow: hidden; }
        .widget-perf-bar {
            height: 100%; background: linear-gradient(90deg, var(--p-primary), #818cf8);
            border-radius: 6px; display: flex; align-items: center; justify-content: flex-end;
            padding-right: 8px; font-size: 12px; color: white; font-weight: 600; min-width: 40px;
        }

        /* ─── Top Questions ─── */
        #topQuestions li {
            margin-bottom: 8px; padding: 10px 14px; background: var(--p-bg);
            border-radius: var(--p-radius-sm); list-style-position: inside; font-size: 14px;
        }
        #topQuestions .question-count {
            float: right; background: var(--p-primary); color: white;
            padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;
        }

        /* ─── Toast Notifications ─── */
        .toast-container {
            position: fixed; top: 20px; right: 20px; z-index: 10000;
            display: flex; flex-direction: column; gap: 8px; pointer-events: none;
        }
        .toast {
            padding: 12px 20px; border-radius: var(--p-radius-sm); font-size: 14px; font-weight: 500;
            box-shadow: var(--p-shadow-md); pointer-events: auto;
            animation: toastIn 0.25s var(--p-ease);
            display: flex; align-items: center; gap: 8px; max-width: 400px;
        }
        .toast.hiding { animation: toastOut 0.2s var(--p-ease) forwards; }
        .toast-success { background: #065f46; color: #d1fae5; }
        .toast-error { background: #991b1b; color: #fee2e2; }
        .toast-warning { background: #92400e; color: var(--p-warning-light); }
        .toast-info { background: #1e3a5f; color: #dbeafe; }
        @keyframes toastIn { from { opacity: 0; transform: translateX(40px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes toastOut { from { opacity: 1; transform: translateX(0); } to { opacity: 0; transform: translateX(40px); } }

        /* ─── Skeleton Loading ─── */
        .skeleton { background: linear-gradient(90deg, #e2e8f0 25%, #f1f5f9 50%, #e2e8f0 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 6px; }
        .skeleton-line { height: 14px; margin-bottom: 10px; }
        .skeleton-card { height: 100px; border-radius: var(--p-radius); }
        .skeleton-bar { height: 24px; margin-bottom: 8px; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

        /* ─── Responsive ─── */
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
            .sidebar-overlay.open { display: block; }
            .main-content { margin-left: 0; }
            .hamburger { display: block; }
            .topbar { padding: 16px 20px; }
            .content-area { padding: 20px 16px; }
            .stats-grid { grid-template-columns: 1fr 1fr; }
            .chat-preview-container { flex-direction: column; }
            .chat-preview-box { max-width: 100%; }
        }
        @media (max-width: 480px) {
            .stats-grid { grid-template-columns: 1fr; }
        }
        @media (max-width: 800px) {
            #tab-analytics > div:last-child { grid-template-columns: 1fr; }
        }

        @media (prefers-reduced-motion: reduce) {
            .tab-content, .toast, .modal-content, .stat-card { animation: none !important; transition: none !important; }
        }
    </style>
</head>
<body>
    <!-- Login Form -->
    <div class="login-container" id="loginForm">
        <h1>ChatBot Platform</h1>
        <p class="login-subtitle">Sign in to your customer portal</p>
        <form onsubmit="login(event)">
            <div class="form-group">
                <label for="apiKey">API Key</label>
                <input type="password" id="apiKey" placeholder="cb_live_..." required>
            </div>
            <button type="submit" class="btn" id="loginBtn">Sign In</button>
            <div class="error" id="loginError"></div>
        </form>
    </div>

    <!-- Dashboard -->
    <div class="dashboard" id="dashboard">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-brand">
                <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/></svg>
                <span>ChatBot</span>
            </div>
            <nav class="sidebar-nav">
                <a class="nav-item active" onclick="showTab('overview')" data-tab="overview">
                    <svg viewBox="0 0 24 24"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/></svg>
                    <span>Overview</span>
                </a>
                <a class="nav-item" onclick="showTab('analytics')" data-tab="analytics">
                    <svg viewBox="0 0 24 24"><path d="M5 9.2h3V19H5zM10.6 5h2.8v14h-2.8zm5.6 8H19v6h-2.8z"/></svg>
                    <span>Analytics</span>
                </a>
                <a class="nav-item" onclick="showTab('widgets')" data-tab="widgets">
                    <svg viewBox="0 0 24 24"><path d="M13 13v8h8v-8h-8zM3 21h8v-8H3v8zM3 3v8h8V3H3zm13.66-1.31L11 7.34 16.66 13l5.66-5.66-5.66-5.65z"/></svg>
                    <span>Widgets</span>
                </a>
                <a class="nav-item" onclick="showTab('conversations')" data-tab="conversations">
                    <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 9h12v2H6V9zm8 5H6v-2h8v2zm4-6H6V6h12v2z"/></svg>
                    <span>Conversations</span>
                </a>
                <a class="nav-item" onclick="showTab('playground')" data-tab="playground">
                    <svg viewBox="0 0 24 24"><path d="M7 14c-1.66 0-3-1.34-3-3 0-1.31.84-2.41 2-2.83V4.5C6 3.12 7.12 2 8.5 2S11 3.12 11 4.5V8h2V4.5C13 3.12 14.12 2 15.5 2S18 3.12 18 4.5v3.67c1.16.42 2 1.52 2 2.83 0 1.66-1.34 3-3 3h-1v4l-4 3v-7H7z"/></svg>
                    <span>Playground</span>
                </a>
                <a class="nav-item" onclick="showTab('knowledge')" data-tab="knowledge">
                    <svg viewBox="0 0 24 24"><path d="M18 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 4h5v8l-2.5-1.5L6 12V4z"/></svg>
                    <span>Knowledge Base</span>
                </a>
                <a class="nav-item" onclick="showTab('setup')" data-tab="setup">
                    <svg viewBox="0 0 24 24"><path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0l4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"/></svg>
                    <span>Widget Setup</span>
                </a>
            </nav>
            <div class="sidebar-footer">
                <span class="tier-badge" id="tierBadge"></span>
                <span class="company-name" id="companyName"></span>
                <button class="logout-btn" onclick="logout()">Sign Out</button>
            </div>
        </aside>
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

        <!-- Main -->
        <main class="main-content">
            <div class="topbar">
                <button class="hamburger" id="hamburger" onclick="toggleSidebar()">&#9776;</button>
                <h1 class="page-title" id="pageTitle">Overview</h1>
            </div>
            <div class="content-area">
                <!-- Overview Tab -->
                <div class="tab-content active" id="tab-overview">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3>Messages Used</h3>
                            <div class="value" id="messagesUsed">-</div>
                            <div class="sub">this month</div>
                            <div class="usage-bar"><div class="usage-bar-fill" id="usageBar" style="width: 0%"></div></div>
                        </div>
                        <div class="stat-card">
                            <h3>Messages Remaining</h3>
                            <div class="value" id="messagesRemaining">-</div>
                            <div class="sub" id="messageLimit">of - limit</div>
                        </div>
                        <div class="stat-card success">
                            <h3>Widgets</h3>
                            <div class="value" id="widgetsCount">-</div>
                            <div class="sub">active chatbots</div>
                        </div>
                        <div class="stat-card">
                            <h3>Documents</h3>
                            <div class="value"><span id="documentsCountOverview">-</span> / <span id="documentsLimitOverview">-</span></div>
                            <div class="sub">in knowledge base</div>
                            <div class="usage-bar"><div class="usage-bar-fill" id="docUsageBar" style="width: 0%"></div></div>
                        </div>
                    </div>
                    <div class="section">
                        <h2>Usage Details</h2>
                        <div class="stats-grid">
                            <div class="stat-card"><h3>Input Tokens</h3><div class="value" id="inputTokens">-</div></div>
                            <div class="stat-card"><h3>Output Tokens</h3><div class="value" id="outputTokens">-</div></div>
                            <div class="stat-card"><h3>Documents</h3><div class="value"><span id="documentsCount">-</span> / <span id="documentsLimitDetail">-</span></div></div>
                        </div>
                    </div>
                </div>

                <!-- Analytics Tab -->
                <div class="tab-content" id="tab-analytics">
                    <div class="stats-grid">
                        <div class="stat-card"><h3>All-Time Messages</h3><div class="value" id="analyticsAllTimeMessages">-</div><div class="sub">total</div></div>
                        <div class="stat-card"><h3>This Month</h3><div class="value" id="analyticsMonthlyMessages">-</div><div class="sub">messages</div></div>
                        <div class="stat-card"><h3>Conversations</h3><div class="value" id="analyticsConversations">-</div><div class="sub">all-time</div></div>
                        <div class="stat-card"><h3>Avg Response</h3><div class="value" id="analyticsAvgResponse">-</div><div class="sub">seconds</div></div>
                    </div>
                    <div class="section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h2 style="border: none; margin: 0; padding: 0;">Usage Trend</h2>
                            <div style="display: flex; gap: 12px; align-items: center;">
                                <div class="period-selector">
                                    <button class="btn btn-sm btn-secondary period-btn active" data-days="30">30d</button>
                                    <button class="btn btn-sm btn-secondary period-btn" data-days="90">90d</button>
                                    <button class="btn btn-sm btn-secondary period-btn" data-days="360">360d</button>
                                    <button class="btn btn-sm btn-secondary period-btn" data-days="0">All</button>
                                </div>
                                <button class="btn btn-sm btn-secondary" onclick="exportCSV()" title="Download CSV">&#x2913; CSV</button>
                            </div>
                        </div>
                        <div class="chart-container" id="usageChart"><div class="chart-loading">Loading chart...</div></div>
                        <div class="chart-labels" id="chartLabels"></div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                        <div class="section"><h2>Widget Performance</h2><div id="widgetPerformance">Loading...</div></div>
                        <div class="section"><h2>Top Questions</h2><ol id="topQuestions" style="padding-left: 20px;"><li>Loading...</li></ol></div>
                    </div>
                </div>

                <!-- Widgets Tab -->
                <div class="tab-content" id="tab-widgets">
                    <div class="section">
                        <h2>Your Widgets</h2>
                        <ul class="widget-list" id="widgetList"><li class="widget-item">Loading...</li></ul>
                        <button class="btn btn-sm btn-success" onclick="showCreateWidgetModal()" style="margin-top: 16px;">+ Create Widget</button>
                    </div>
                </div>

                <!-- Conversations Tab -->
                <div class="tab-content" id="tab-conversations">
                    <div class="section">
                        <h2>Recent Conversations</h2>
                        <p>View chat history from your widgets (last 30 days)</p>
                        <div class="form-group" style="max-width: 300px; margin-bottom: 20px;">
                            <label for="conversationWidgetFilter">Filter by Widget</label>
                            <select id="conversationWidgetFilter" onchange="loadConversations()"><option value="">All Widgets</option></select>
                        </div>
                        <ul class="widget-list" id="conversationList"><li class="widget-item">Loading...</li></ul>
                    </div>
                </div>

                <!-- Conversation Detail Modal -->
                <div class="modal" id="conversationModal">
                    <div class="modal-content" style="max-width: 800px;">
                        <div class="modal-header"><h2>Conversation Details</h2><button class="modal-close" onclick="closeModal('conversationModal')">&times;</button></div>
                        <div id="conversationMessages" style="max-height: 500px; overflow-y: auto;">Loading...</div>
                    </div>
                </div>

                <!-- Playground Tab -->
                <div class="tab-content" id="tab-playground">
                    <div class="section">
                        <h2>Test Your Chatbot</h2>
                        <p>Try out your chatbot with the current configuration. Changes to settings will be reflected immediately.</p>
                        <div class="chat-preview-container">
                            <div class="chat-preview-settings">
                                <div class="form-group"><label for="playgroundWidget">Select Widget</label><select id="playgroundWidget" onchange="loadWidgetForPlayground()"><option value="">-- Select a widget --</option></select></div>
                                <div class="form-group"><label for="playgroundModel">AI Model</label>
                                    <select id="playgroundModel">
                                        <option value="gemini-3-flash-preview">Gemini 3 Flash (Newest, Fast)</option>
                                        <option value="gemini-3-pro-preview">Gemini 3 Pro (Newest, Most Capable)</option>
                                        <option value="gemini-2.0-flash-001">Gemini 2.0 Flash</option>
                                        <option value="gemini-2.0-pro-exp-02-05">Gemini 2.0 Pro</option>
                                    </select>
                                </div>
                                <div class="form-group"><label for="playgroundSystemPrompt">System Prompt (Guardrails)</label><textarea id="playgroundSystemPrompt" rows="10" placeholder="Enter your system prompt with guardrails..."></textarea></div>
                                <div style="display: flex; gap: 10px; margin-top: 10px;">
                                    <button class="btn btn-sm btn-secondary" onclick="useGuardrailTemplate()">Load Default Template</button>
                                    <button class="btn btn-sm btn-primary" onclick="savePlaygroundSettings()">Save Settings to Widget</button>
                                </div>
                            </div>
                            <div class="chat-preview-box">
                                <div class="chat-header" id="playgroundChatHeader" style="background: var(--p-primary);">Chat Preview</div>
                                <div class="chat-messages" id="playgroundMessages"><div class="chat-message assistant"><div class="bubble">Select a widget to start testing.</div></div></div>
                                <div class="chat-input-area"><input type="text" id="playgroundInput" placeholder="Type a message..." onkeypress="if(event.key==='Enter')sendPlaygroundMessage()"><button onclick="sendPlaygroundMessage()">Send</button></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Knowledge Base Tab -->
                <div class="tab-content" id="tab-knowledge">
                    <div class="section" style="padding: 14px 24px; background: var(--p-primary-light); border-radius: var(--p-radius-sm); margin-bottom: 16px; box-shadow: none;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 600; color: var(--p-text); font-size: 14px;">Documents: <span id="docsUsedKB">-</span> / <span id="docsLimitKB">-</span></span>
                            <span style="font-size: 13px; color: var(--p-text-sec);" id="docsRemainingKB"></span>
                        </div>
                        <div class="usage-bar" style="margin-top: 8px;"><div class="usage-bar-fill" id="docUsageBarKB" style="width: 0%"></div></div>
                    </div>
                    <div class="section">
                        <h2>Upload Documents</h2>
                        <p>Upload PDF, DOCX, TXT, or MD files (max 20MB each, up to 10 files at once).</p>
                        <div class="form-group" style="max-width: 350px; margin-bottom: 16px;">
                            <label for="uploadTargetWidget">Assign to Widget</label>
                            <select id="uploadTargetWidget">
                                <option value="">No widget (upload only)</option>
                            </select>
                            <small style="color: var(--p-text-muted);">Uploaded documents will be auto-assigned to the selected widget.</small>
                        </div>
                        <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
                            <input type="file" id="fileInput" accept=".pdf,.docx,.doc,.txt,.md" multiple onchange="uploadFiles(this.files)">
                            <p style="font-size: 18px; color: var(--p-text-sec);">Drop files here or click to upload</p>
                            <p style="font-size: 13px; color: var(--p-text-muted); margin-top: 8px;">Supported: PDF, DOCX, TXT, MD (multiple files allowed)</p>
                        </div>
                        <div id="uploadStatus" style="margin-top: 16px;"></div>
                    </div>
                    <div class="section">
                        <h2>Scrape Website</h2>
                        <p>Add content from a URL or sitemap to your knowledge base.</p>
                        <div class="inline-form">
                            <div class="form-group"><label for="scrapeUrl">URL</label><input type="url" id="scrapeUrl" placeholder="https://example.com" required></div>
                            <div class="form-group" style="max-width: 150px;"><label for="scrapeType">Type</label><select id="scrapeType"><option value="single">Single Page</option><option value="sitemap">Sitemap</option></select></div>
                            <button class="btn btn-primary btn-sm" onclick="scrapeUrl()">Scrape</button>
                        </div>
                        <div id="scrapeStatus" style="margin-top: 16px;"></div>
                    </div>
                    <div class="section"><h2>Your Documents</h2><ul class="doc-list" id="docList"><li class="doc-item">Loading...</li></ul></div>
                </div>

                <!-- Widget Setup Tab -->
                <div class="tab-content" id="tab-setup">
                    <div class="section">
                        <h2>Widget Setup</h2>
                        <div class="form-group"><label for="setupWidget">Select Widget</label><select id="setupWidget" onchange="loadWidgetSetup()"><option value="">-- Select a widget --</option></select></div>
                        <div id="setupContent" style="display: none;">
                            <h3>1. Install Chat Widget</h3>
                            <p>Paste this code on your site to install the chat widget and enable AI-powered support.</p>
                            <div class="code-block" id="embedCodeBlock"><button class="copy-btn" onclick="copyCode('embedCodeBlock')">Copy</button><code id="setupEmbedCode"></code></div>
                            <h3 style="margin-top: 30px;">2. Identity Verification (Optional)</h3>
                            <div class="alert alert-info">Secure your AI Agent by generating a JWT for each logged-in user. This enables secure identity verification for personalized responses.</div>
                            <p><strong>Secret Key:</strong></p>
                            <div class="secret-display">
                                <code id="jwtSecretDisplay">Not configured</code>
                                <button class="btn btn-sm btn-secondary" onclick="regenerateJwtSecret()">Regenerate</button>
                                <button class="btn btn-sm btn-primary" onclick="copySecret()">Copy</button>
                            </div>
                            <h3 style="margin-top: 20px;">Server-side Code (Node.js)</h3>
                            <div class="code-block" id="serverCodeBlock"><button class="copy-btn" onclick="copyCode('serverCodeBlock')">Copy</button><code id="serverCode"></code></div>
                            <h3 style="margin-top: 20px;">Client-side Code</h3>
                            <div class="code-block" id="clientCodeBlock"><button class="copy-btn" onclick="copyCode('clientCodeBlock')">Copy</button><code id="clientCode"></code></div>
                            <h3 style="margin-top: 30px;">3. Allowed Domains (Optional)</h3>
                            <p>Restrict where your widget can be embedded for security.</p>
                            <div class="form-group">
                                <input type="text" id="allowedDomains" placeholder="example.com, app.example.com">
                                <small style="color: var(--p-text-muted);">Comma-separated list of domains. Leave empty to allow all.</small>
                            </div>
                            <button class="btn btn-sm btn-primary" onclick="saveAllowedDomains()">Save Domains</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Create Widget Modal -->
    <div class="modal" id="createWidgetModal">
        <div class="modal-content">
            <div class="modal-header"><h2>Create Widget</h2><button class="modal-close" onclick="closeModal('createWidgetModal')">&times;</button></div>
            <form onsubmit="createWidget(event)">
                <div class="form-group"><label for="widgetName">Widget Name</label><input type="text" id="widgetName" placeholder="My Chatbot" required></div>
                <div class="form-group"><label for="chatbotName">Chatbot Display Name</label><input type="text" id="chatbotName" placeholder="Assistant" value="Assistant"></div>
                <div class="form-group"><label for="welcomeMessage">Welcome Message</label><input type="text" id="welcomeMessage" placeholder="Hello! How can I help you?" value="Hello! How can I help you?"></div>
                <div class="form-group"><label for="systemPrompt">System Prompt (with Guardrails)</label><textarea id="systemPrompt" rows="8"></textarea></div>
                <div class="form-group"><label for="widgetModel">AI Model</label>
                    <select id="widgetModel">
                        <option value="gemini-3-flash-preview">Gemini 3 Flash (Newest, Fast)</option>
                        <option value="gemini-3-pro-preview">Gemini 3 Pro (Newest, Most Capable)</option>
                        <option value="gemini-2.0-flash-001">Gemini 2.0 Flash</option>
                        <option value="gemini-2.0-pro-exp-02-05">Gemini 2.0 Pro</option>
                    </select>
                </div>
                <div class="form-group"><label for="widgetColor">Widget Color</label><input type="color" id="widgetColor" value="#4f46e5"></div>
                <button type="submit" class="btn">Create Widget</button>
            </form>
        </div>
    </div>

    <!-- Edit Widget Modal -->
    <div class="modal" id="editWidgetModal">
        <div class="modal-content">
            <div class="modal-header"><h2>Edit Widget</h2><button class="modal-close" onclick="closeModal('editWidgetModal')">&times;</button></div>
            <form onsubmit="saveWidget(event)">
                <input type="hidden" id="editWidgetId">
                <div class="form-group"><label for="editWidgetName">Widget Name</label><input type="text" id="editWidgetName" required></div>
                <div class="form-group"><label for="editChatbotName">Chatbot Display Name</label><input type="text" id="editChatbotName"></div>
                <div class="form-group"><label for="editWelcomeMessage">Welcome Message</label><input type="text" id="editWelcomeMessage"></div>
                <div class="form-group"><label for="editSystemPrompt">System Prompt (with Guardrails)</label><textarea id="editSystemPrompt" rows="8"></textarea></div>
                <div class="form-group"><label for="editWidgetModel">AI Model</label>
                    <select id="editWidgetModel">
                        <option value="gemini-3-flash-preview">Gemini 3 Flash (Newest, Fast)</option>
                        <option value="gemini-3-pro-preview">Gemini 3 Pro (Newest, Most Capable)</option>
                        <option value="gemini-2.0-flash-001">Gemini 2.0 Flash</option>
                        <option value="gemini-2.0-pro-exp-02-05">Gemini 2.0 Pro</option>
                    </select>
                </div>
                <div class="form-group"><label for="editWidgetColor">Widget Color</label><input type="color" id="editWidgetColor"></div>
                <div class="form-group">
                    <label>Knowledge Base Documents</label>
                    <div id="editDocumentPicker" style="max-height: 200px; overflow-y: auto; border: 1.5px solid var(--p-border); border-radius: var(--p-radius-sm); padding: 8px;">
                        <p style="color: var(--p-text-muted); font-size: 13px;">Loading documents...</p>
                    </div>
                    <small style="color: var(--p-text-muted);">Select which documents this bot can use for answers.</small>
                    <input type="hidden" id="editDocumentIds">
                </div>
                <button type="submit" class="btn">Save Changes</button>
            </form>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
        const API_URL = window.location.origin;
        let apiKey = localStorage.getItem('chatbot_api_key');
        let widgets = [];
        let currentPlaygroundWidget = null;
        let playgroundSessionId = null;

        const DEFAULT_GUARDRAILS = `You are a helpful AI assistant for our company.

GUARDRAILS - You MUST follow these rules:

1. ALLOWED TOPICS:
   - Questions about our products and services
   - General customer support inquiries
   - Company information and policies
   - Technical help related to our offerings

2. FORBIDDEN TOPICS - Do NOT discuss:
   - Competitor products or comparisons
   - Political, religious, or controversial topics
   - Personal opinions or advice
   - Any illegal activities
   - Medical, legal, or financial advice

3. BEHAVIOR RULES:
   - Always be polite and professional
   - If unsure, say "I don't have that information"
   - Never make up facts or data
   - Redirect off-topic questions politely
   - Protect user privacy - never ask for sensitive data

4. RESPONSE STYLE:
   - Keep responses concise and helpful
   - Use bullet points for complex information
   - Offer to clarify if the question is ambiguous

If asked about forbidden topics, respond:
"I'm focused on helping you with [company] products and services. Is there something specific about our offerings I can help you with?"`;

        // ─── Toast Notifications ───
        function showToast(message, type) {
            type = type || 'info';
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = 'toast toast-' + type;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(function() {
                toast.classList.add('hiding');
                setTimeout(function() { toast.remove(); }, 200);
            }, 3000);
        }

        // ─── Sidebar Toggle ───
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('sidebarOverlay').classList.toggle('open');
        }

        // ─── Page Titles ───
        const PAGE_TITLES = {
            overview: 'Overview',
            analytics: 'Analytics',
            widgets: 'Widgets',
            conversations: 'Conversations',
            playground: 'Playground',
            knowledge: 'Knowledge Base',
            setup: 'Widget Setup'
        };

        // Check if already logged in
        if (apiKey) { loadDashboard(); }

        // Set default guardrails
        document.getElementById('systemPrompt').value = DEFAULT_GUARDRAILS;

        // Tab navigation
        function showTab(tabName) {
            document.querySelectorAll('.nav-item').forEach(function(n) { n.classList.remove('active'); });
            document.querySelectorAll('.tab-content').forEach(function(c) { c.classList.remove('active'); });

            var navItem = document.querySelector('[data-tab="' + tabName + '"]');
            if (navItem) navItem.classList.add('active');
            var tabEl = document.getElementById('tab-' + tabName);
            if (tabEl) tabEl.classList.add('active');

            document.getElementById('pageTitle').textContent = PAGE_TITLES[tabName] || tabName;

            // Close sidebar on mobile
            if (window.innerWidth <= 768) { toggleSidebar(); }

            if (tabName === 'analytics') loadAnalytics();
            if (tabName === 'widgets') loadWidgets();
            if (tabName === 'conversations') loadConversationsTab();
            if (tabName === 'knowledge') loadDocuments();
            if (tabName === 'playground') loadPlayground();
            if (tabName === 'setup') loadSetupTab();
        }

        async function login(event) {
            event.preventDefault();
            var key = document.getElementById('apiKey').value;
            var btn = document.getElementById('loginBtn');
            var error = document.getElementById('loginError');

            btn.disabled = true;
            btn.textContent = 'Signing in...';
            error.textContent = '';

            try {
                var response = await fetch(API_URL + '/api/portal/dashboard', {
                    headers: { 'Authorization': 'Bearer ' + key }
                });
                if (!response.ok) throw new Error('Invalid API key');
                localStorage.setItem('chatbot_api_key', key);
                apiKey = key;
                loadDashboard();
            } catch (e) {
                error.textContent = e.message;
            } finally {
                btn.disabled = false;
                btn.textContent = 'Sign In';
            }
        }

        function logout() {
            localStorage.removeItem('chatbot_api_key');
            apiKey = null;
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('dashboard').classList.remove('active');
        }

        async function loadDashboard() {
            try {
                var response = await fetch(API_URL + '/api/portal/dashboard', {
                    headers: { 'Authorization': 'Bearer ' + apiKey }
                });
                if (!response.ok) {
                    if (response.status === 401) { logout(); return; }
                    return;
                }
                var data = await response.json();

                document.getElementById('loginForm').classList.add('hidden');
                document.getElementById('dashboard').classList.add('active');

                document.getElementById('companyName').textContent = data.company_name;
                document.getElementById('tierBadge').textContent = data.subscription_tier;
                document.getElementById('tierBadge').className = 'tier-badge tier-' + data.subscription_tier;

                var usage = data.usage;
                var totalLimit = usage.total_messages + usage.messages_remaining;
                var usagePercent = (usage.total_messages / totalLimit) * 100;

                document.getElementById('messagesUsed').textContent = usage.total_messages.toLocaleString();
                document.getElementById('messagesRemaining').textContent = usage.messages_remaining.toLocaleString();
                document.getElementById('messageLimit').textContent = 'of ' + totalLimit.toLocaleString() + ' limit';
                document.getElementById('widgetsCount').textContent = data.widgets_count;
                document.getElementById('documentsCountOverview').textContent = data.documents_count;
                document.getElementById('documentsLimitOverview').textContent = data.documents_limit;
                document.getElementById('inputTokens').textContent = usage.total_input_tokens.toLocaleString();
                document.getElementById('outputTokens').textContent = usage.total_output_tokens.toLocaleString();
                document.getElementById('documentsCount').textContent = data.documents_count;
                document.getElementById('documentsLimitDetail').textContent = data.documents_limit;

                var docPercent = (data.documents_count / Math.max(data.documents_limit, 1)) * 100;
                var docBar = document.getElementById('docUsageBar');
                docBar.style.width = Math.min(docPercent, 100) + '%';
                docBar.className = 'usage-bar-fill';
                if (docPercent > 80) docBar.classList.add('warning');
                if (docPercent > 95) docBar.classList.add('danger');

                document.getElementById('docsUsedKB').textContent = data.documents_count;
                document.getElementById('docsLimitKB').textContent = data.documents_limit;
                var docsRemaining = Math.max(0, data.documents_limit - data.documents_count);
                document.getElementById('docsRemainingKB').textContent = docsRemaining > 0
                    ? docsRemaining + ' remaining'
                    : 'Limit reached - upgrade your plan';
                var docBarKB = document.getElementById('docUsageBarKB');
                docBarKB.style.width = Math.min(docPercent, 100) + '%';
                docBarKB.className = 'usage-bar-fill';
                if (docPercent > 80) docBarKB.classList.add('warning');
                if (docPercent > 95) docBarKB.classList.add('danger');

                var usageBar = document.getElementById('usageBar');
                usageBar.style.width = Math.min(usagePercent, 100) + '%';
                usageBar.className = 'usage-bar-fill';
                if (usagePercent > 80) usageBar.classList.add('warning');
                if (usagePercent > 95) usageBar.classList.add('danger');

                await loadWidgetsData();
            } catch (e) {
                console.error(e);
                logout();
            }
        }

        async function loadWidgetsData() {
            try {
                var response = await fetch(API_URL + '/api/portal/widgets', {
                    headers: { 'Authorization': 'Bearer ' + apiKey }
                });
                widgets = await response.json();
            } catch (e) {
                console.error(e);
            }
        }

        async function loadWidgets() {
            await loadWidgetsData();
            var list = document.getElementById('widgetList');
            if (widgets.length === 0) {
                list.innerHTML = '<li class="widget-item" style="justify-content: center; color: var(--p-text-muted);">No widgets yet. Create one to get started!</li>';
                return;
            }
            list.innerHTML = widgets.map(function(w) {
                return '<li class="widget-item"><div class="widget-info"><h4>' + escapeHtml(w.name) + '</h4><span>Chatbot: ' + escapeHtml(w.chatbot_name) + ' | Model: ' + (w.model || 'gemini-3-flash-preview') + ' | ' + (w.is_active ? 'Active' : 'Inactive') + '</span></div><div class="widget-actions"><button class="btn-warning btn-sm" onclick="testWidget(\'' + w.id + '\')">Test</button><button class="btn-secondary btn-sm" onclick="showEditWidgetModal(\'' + w.id + '\')">Edit</button><button class="btn-primary btn-sm" onclick="showTab(\'setup\'); document.getElementById(\'setupWidget\').value=\'' + w.id + '\'; loadWidgetSetup();">Setup</button></div></li>';
            }).join('');
        }

        function testWidget(widgetId) {
            document.getElementById('playgroundWidget').value = widgetId;
            showTab('playground');
            loadWidgetForPlayground();
        }

        async function loadPlayground() {
            var select = document.getElementById('playgroundWidget');
            select.innerHTML = '<option value="">-- Select a widget --</option>' +
                widgets.map(function(w) { return '<option value="' + w.id + '">' + escapeHtml(w.name) + '</option>'; }).join('');
        }

        async function loadWidgetForPlayground() {
            var widgetId = document.getElementById('playgroundWidget').value;
            if (!widgetId) return;
            var widget = widgets.find(function(w) { return w.id === widgetId; });
            if (!widget) return;
            currentPlaygroundWidget = widget;
            playgroundSessionId = 'playground-' + Date.now();
            document.getElementById('playgroundModel').value = widget.model || 'gemini-3-flash-preview';
            document.getElementById('playgroundSystemPrompt').value = widget.system_prompt || '';
            document.getElementById('playgroundChatHeader').textContent = widget.chatbot_name || 'Chat Preview';
            document.getElementById('playgroundChatHeader').style.background = widget.widget_color || 'var(--p-primary)';
            document.getElementById('playgroundMessages').innerHTML = '<div class="chat-message assistant"><div class="bubble">' + escapeHtml(widget.welcome_message || 'Hello! How can I help you?') + '</div></div>';
        }

        async function sendPlaygroundMessage() {
            var input = document.getElementById('playgroundInput');
            var message = input.value.trim();
            if (!message || !currentPlaygroundWidget) return;
            var messagesDiv = document.getElementById('playgroundMessages');
            messagesDiv.innerHTML += '<div class="chat-message user"><div class="bubble">' + escapeHtml(message) + '</div></div>';
            input.value = '';
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            messagesDiv.innerHTML += '<div class="chat-message assistant" id="loadingMsg"><div class="bubble"><span class="spinner"></span> Thinking...</div></div>';
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            try {
                var playgroundPrompt = document.getElementById('playgroundSystemPrompt').value;
                var playgroundModel = document.getElementById('playgroundModel').value;
                var response = await fetch(API_URL + '/api/chat/widget/' + currentPlaygroundWidget.id, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        session_id: playgroundSessionId,
                        system_prompt: playgroundPrompt || undefined,
                        model_id: playgroundModel || undefined
                    })
                });
                var data = await response.json();
                var el = document.getElementById('loadingMsg');
                if (el) el.remove();
                if (response.ok) {
                    messagesDiv.innerHTML += '<div class="chat-message assistant"><div class="bubble">' + renderMarkdown(data.message) + '</div></div>';
                } else {
                    messagesDiv.innerHTML += '<div class="chat-message assistant"><div class="bubble" style="background: var(--p-danger-light); border-color: var(--p-danger);">Error: ' + escapeHtml(data.detail || 'Unknown error') + '</div></div>';
                }
            } catch (e) {
                var el2 = document.getElementById('loadingMsg');
                if (el2) el2.remove();
                messagesDiv.innerHTML += '<div class="chat-message assistant"><div class="bubble" style="background: var(--p-danger-light); border-color: var(--p-danger);">Error: ' + e.message + '</div></div>';
            }
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function useGuardrailTemplate() {
            document.getElementById('playgroundSystemPrompt').value = DEFAULT_GUARDRAILS;
        }

        // Conversations
        async function loadConversationsTab() {
            var select = document.getElementById('conversationWidgetFilter');
            select.innerHTML = '<option value="">All Widgets</option>' +
                widgets.map(function(w) { return '<option value="' + w.id + '">' + escapeHtml(w.name) + '</option>'; }).join('');
            await loadConversations();
        }

        async function loadConversations() {
            var widgetId = document.getElementById('conversationWidgetFilter').value;
            var list = document.getElementById('conversationList');
            try {
                var url = API_URL + '/api/portal/conversations';
                if (widgetId) url += '?widget_id=' + widgetId;
                var response = await fetch(url, { headers: { 'Authorization': 'Bearer ' + apiKey } });
                var data = await response.json();
                if (!data.conversations || data.conversations.length === 0) {
                    list.innerHTML = '<li class="widget-item" style="justify-content: center; color: var(--p-text-muted);">No conversations yet.</li>';
                    return;
                }
                list.innerHTML = data.conversations.map(function(c) {
                    return '<li class="widget-item"><div class="widget-info"><h4>' + escapeHtml(c.first_message.substring(0, 80)) + (c.first_message.length > 80 ? '...' : '') + '</h4><span>Widget: ' + escapeHtml(c.widget_name) + ' | Messages: ' + c.message_count + ' | ' + formatDate(c.last_message_at) + '</span></div><div class="widget-actions"><button class="btn-primary btn-sm" onclick="viewConversation(\'' + c.id + '\')">View</button></div></li>';
                }).join('');
            } catch (e) {
                list.innerHTML = '<li class="widget-item">Error loading conversations: ' + e.message + '</li>';
            }
        }

        async function viewConversation(conversationId) {
            var container = document.getElementById('conversationMessages');
            container.innerHTML = '<div class="skeleton skeleton-line" style="width:80%"></div><div class="skeleton skeleton-line" style="width:60%"></div><div class="skeleton skeleton-line" style="width:90%"></div>';
            document.getElementById('conversationModal').classList.add('active');
            try {
                var response = await fetch(API_URL + '/api/portal/conversations/' + conversationId + '/messages', {
                    headers: { 'Authorization': 'Bearer ' + apiKey }
                });
                var data = await response.json();
                if (!data.messages || data.messages.length === 0) {
                    container.innerHTML = '<p style="color: var(--p-text-muted);">No messages found.</p>';
                    return;
                }
                container.innerHTML = data.messages.map(function(m) {
                    return '<div class="chat-message ' + m.role + '" style="margin-bottom: 16px;"><div style="font-size: 12px; color: var(--p-text-muted); margin-bottom: 4px;"><strong>' + (m.role === 'user' ? 'User' : 'Assistant') + '</strong>' + (m.created_at ? ' - ' + formatDate(m.created_at) : '') + '</div><div class="bubble" style="display: inline-block; max-width: 90%; ' + (m.role === 'user' ? 'background: var(--p-primary); color: white;' : 'background: var(--p-bg);') + '">' + escapeHtml(m.content) + '</div></div>';
                }).join('');
            } catch (e) {
                container.innerHTML = '<p class="error">Error: ' + e.message + '</p>';
            }
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            var date = new Date(dateStr);
            return date.toLocaleString('cs-CZ', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
        }

        // Analytics
        var currentAnalyticsPeriod = 30;

        async function loadAnalytics() {
            await Promise.all([loadAnalyticsOverview(), loadUsageChart(currentAnalyticsPeriod), loadWidgetPerformance(), loadTopQuestions()]);
            document.querySelectorAll('.period-btn').forEach(function(btn) {
                btn.addEventListener('click', async function() {
                    document.querySelectorAll('.period-btn').forEach(function(b) { b.classList.remove('active'); });
                    this.classList.add('active');
                    currentAnalyticsPeriod = parseInt(this.dataset.days);
                    await loadUsageChart(currentAnalyticsPeriod);
                });
            });
        }

        async function loadAnalyticsOverview() {
            try {
                var response = await fetch(API_URL + '/api/portal/analytics/overview', { headers: { 'Authorization': 'Bearer ' + apiKey } });
                var data = await response.json();
                document.getElementById('analyticsAllTimeMessages').textContent = data.all_time.total_messages.toLocaleString();
                document.getElementById('analyticsMonthlyMessages').textContent = data.current_month.messages.toLocaleString();
                document.getElementById('analyticsConversations').textContent = data.all_time.total_conversations.toLocaleString();
                var avgSec = (data.all_time.avg_response_time_ms / 1000).toFixed(2);
                document.getElementById('analyticsAvgResponse').textContent = avgSec + 's';
            } catch (e) { console.error('Failed to load analytics overview:', e); }
        }

        async function loadUsageChart(days) {
            var container = document.getElementById('usageChart');
            var labels = document.getElementById('chartLabels');
            container.innerHTML = '<div class="chart-loading"><span class="spinner"></span> Loading chart...</div>';
            try {
                var response = await fetch(API_URL + '/api/portal/analytics/daily-usage?days=' + days, { headers: { 'Authorization': 'Bearer ' + apiKey } });
                var data = await response.json();
                if (!data.data || data.data.length === 0) { container.innerHTML = '<div class="chart-loading">No data yet</div>'; labels.innerHTML = ''; return; }
                var maxMessages = Math.max.apply(null, data.data.map(function(d) { return d.messages; }).concat([1]));
                container.innerHTML = data.data.map(function(d) {
                    var height = (d.messages / maxMessages) * 100;
                    var date = new Date(d.date);
                    var tooltip = date.toLocaleDateString('cs-CZ') + ': ' + d.messages + ' messages';
                    return '<div class="chart-bar" style="height: ' + Math.max(height, 2) + '%" data-tooltip="' + tooltip + '"></div>';
                }).join('');
                var firstDate = new Date(data.data[0].date);
                var lastDate = new Date(data.data[data.data.length - 1].date);
                labels.innerHTML = '<span>' + firstDate.toLocaleDateString('cs-CZ') + '</span><span>' + lastDate.toLocaleDateString('cs-CZ') + '</span>';
            } catch (e) { container.innerHTML = '<div class="chart-loading">Error loading chart</div>'; console.error('Failed to load usage chart:', e); }
        }

        async function loadWidgetPerformance() {
            var container = document.getElementById('widgetPerformance');
            try {
                var response = await fetch(API_URL + '/api/portal/analytics/widgets', { headers: { 'Authorization': 'Bearer ' + apiKey } });
                var data = await response.json();
                if (!data.widgets || data.widgets.length === 0) { container.innerHTML = '<p style="color: var(--p-text-muted);">No widgets yet</p>'; return; }
                var maxMessages = Math.max.apply(null, data.widgets.map(function(w) { return w.messages; }).concat([1]));
                container.innerHTML = data.widgets.map(function(w) {
                    var width = (w.messages / maxMessages) * 100;
                    return '<div class="widget-perf-item"><div class="widget-perf-name" title="' + escapeHtml(w.name) + '">' + escapeHtml(w.name) + '</div><div class="widget-perf-bar-container"><div class="widget-perf-bar" style="width: ' + Math.max(width, 5) + '%">' + w.messages + '</div></div></div>';
                }).join('');
            } catch (e) { container.innerHTML = '<p class="error">Error loading widget performance</p>'; console.error('Failed to load widget performance:', e); }
        }

        async function loadTopQuestions() {
            var container = document.getElementById('topQuestions');
            try {
                var response = await fetch(API_URL + '/api/portal/analytics/top-questions?limit=10', { headers: { 'Authorization': 'Bearer ' + apiKey } });
                var data = await response.json();
                if (!data.questions || data.questions.length === 0) { container.innerHTML = '<li style="color: var(--p-text-muted);">No questions yet</li>'; return; }
                container.innerHTML = data.questions.map(function(q) {
                    return '<li><span class="question-count">' + q.count + 'x</span>' + escapeHtml(q.text.substring(0, 80)) + (q.text.length > 80 ? '...' : '') + '</li>';
                }).join('');
            } catch (e) { container.innerHTML = '<li class="error">Error loading questions</li>'; console.error('Failed to load top questions:', e); }
        }

        async function exportCSV() {
            try {
                var response = await fetch(API_URL + '/api/portal/analytics/export?days=' + currentAnalyticsPeriod, { headers: { 'Authorization': 'Bearer ' + apiKey } });
                if (!response.ok) throw new Error('Export failed');
                var blob = await response.blob();
                var url = window.URL.createObjectURL(blob);
                var a = document.createElement('a');
                a.href = url;
                a.download = 'analytics_' + (currentAnalyticsPeriod === 0 ? 'all' : currentAnalyticsPeriod + 'd') + '.csv';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                showToast('CSV exported successfully', 'success');
            } catch (e) { showToast('Failed to export CSV: ' + e.message, 'error'); console.error('CSV export error:', e); }
        }

        async function savePlaygroundSettings() {
            if (!currentPlaygroundWidget) { showToast('Please select a widget first', 'warning'); return; }
            var data = { model: document.getElementById('playgroundModel').value, system_prompt: document.getElementById('playgroundSystemPrompt').value };
            try {
                var response = await fetch(API_URL + '/api/portal/widgets/' + currentPlaygroundWidget.id, {
                    method: 'PATCH',
                    headers: { 'Authorization': 'Bearer ' + apiKey, 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (!response.ok) throw new Error('Save failed');
                showToast('Settings saved!', 'success');
                await loadWidgetsData();
                currentPlaygroundWidget = widgets.find(function(w) { return w.id === currentPlaygroundWidget.id; });
            } catch (e) { showToast('Error: ' + e.message, 'error'); }
        }

        async function loadSetupTab() {
            var select = document.getElementById('setupWidget');
            select.innerHTML = '<option value="">-- Select a widget --</option>' +
                widgets.map(function(w) { return '<option value="' + w.id + '">' + escapeHtml(w.name) + '</option>'; }).join('');
        }

        async function loadWidgetSetup() {
            var widgetId = document.getElementById('setupWidget').value;
            if (!widgetId) { document.getElementById('setupContent').style.display = 'none'; return; }
            document.getElementById('setupContent').style.display = 'block';
            try {
                var response = await fetch(API_URL + '/api/portal/widgets/' + widgetId + '/embed-code', { headers: { 'Authorization': 'Bearer ' + apiKey } });
                var data = await response.json();
                document.getElementById('setupEmbedCode').textContent = data.standard;
                var widget = widgets.find(function(w) { return w.id === widgetId; });
                var jwtSecret = data.jwt_secret || 'Not configured - enable in widget settings';
                document.getElementById('jwtSecretDisplay').textContent = jwtSecret;
                document.getElementById('serverCode').textContent = '// --- SERVER CODE (Node.js) ---\nconst jwt = require(\'jsonwebtoken\');\n\nconst secret = process.env.CHATBOT_IDENTITY_SECRET; // Store securely!\n// Secret: ' + jwtSecret.substring(0, 10) + '...\n\nconst user = await getSignedInUser(); // Get current user\n\nconst token = jwt.sign(\n    {\n        user_id: user.id,\n        email: user.email,\n        name: user.name,\n        // ... other custom attributes\n    },\n    secret,\n    { expiresIn: \'1h\' }\n);\n\n// Send token to client';
                document.getElementById('clientCode').textContent = '// --- CLIENT CODE ---\nconst token = await getUserToken(); // Get token from your server\n\n// Identify the user with the chatbot\nwindow.ChatbotWidget.identify(token);';
                document.getElementById('allowedDomains').value = (widget && widget.allowed_domains ? widget.allowed_domains : []).join(', ');
            } catch (e) { console.error(e); }
        }

        async function regenerateJwtSecret() {
            var widgetId = document.getElementById('setupWidget').value;
            if (!widgetId) return;
            if (!confirm('Regenerate JWT secret? Existing tokens will become invalid.')) return;
            try {
                var response = await fetch(API_URL + '/api/portal/widgets/' + widgetId + '/regenerate-jwt-secret', {
                    method: 'POST', headers: { 'Authorization': 'Bearer ' + apiKey }
                });
                var data = await response.json();
                document.getElementById('jwtSecretDisplay').textContent = data.jwt_secret;
                await loadWidgetsData();
                showToast('JWT secret regenerated!', 'success');
            } catch (e) { showToast('Error: ' + e.message, 'error'); }
        }

        function copySecret() {
            var secret = document.getElementById('jwtSecretDisplay').textContent;
            navigator.clipboard.writeText(secret);
            showToast('Secret copied!', 'success');
        }

        async function saveAllowedDomains() {
            var widgetId = document.getElementById('setupWidget').value;
            if (!widgetId) return;
            var domains = document.getElementById('allowedDomains').value.split(',').map(function(d) { return d.trim(); }).filter(function(d) { return d; });
            try {
                await fetch(API_URL + '/api/portal/widgets/' + widgetId, {
                    method: 'PATCH',
                    headers: { 'Authorization': 'Bearer ' + apiKey, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ allowed_domains: domains })
                });
                showToast('Domains saved!', 'success');
                await loadWidgetsData();
            } catch (e) { showToast('Error: ' + e.message, 'error'); }
        }

        function copyCode(blockId) {
            var code = document.querySelector('#' + blockId + ' code').textContent;
            navigator.clipboard.writeText(code);
            showToast('Code copied!', 'success');
        }

        function populateWidgetSelector() {
            var select = document.getElementById('uploadTargetWidget');
            var current = select.value;
            select.innerHTML = '<option value="">No widget (upload only)</option>' +
                widgets.map(function(w) { return '<option value="' + w.id + '">' + escapeHtml(w.name) + '</option>'; }).join('');
            if (current) select.value = current;
        }

        async function assignDocsToWidget(docIds) {
            var widgetId = document.getElementById('uploadTargetWidget').value;
            if (!widgetId || docIds.length === 0) return;
            var widget = widgets.find(function(w) { return w.id === widgetId; });
            if (!widget) return;
            var existing = widget.document_ids || [];
            var merged = existing.slice();
            docIds.forEach(function(id) { if (merged.indexOf(id) === -1) merged.push(id); });
            try {
                var response = await fetch(API_URL + '/api/portal/widgets/' + widgetId, {
                    method: 'PATCH',
                    headers: { 'Authorization': 'Bearer ' + apiKey, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ document_ids: merged })
                });
                if (response.ok) {
                    widget.document_ids = merged;
                    showToast(docIds.length + ' doc(s) assigned to ' + widget.name, 'success');
                }
            } catch (e) { showToast('Failed to assign docs to widget', 'error'); }
        }

        async function loadDocuments() {
            populateWidgetSelector();
            try {
                var response = await fetch(API_URL + '/api/portal/documents', { headers: { 'Authorization': 'Bearer ' + apiKey } });
                var data = await response.json();
                var list = document.getElementById('docList');
                if (!data.documents || data.documents.length === 0) {
                    list.innerHTML = '<li class="doc-item" style="justify-content: center; color: var(--p-text-muted);">No documents yet. Upload files or scrape websites above.</li>';
                    return;
                }
                list.innerHTML = data.documents.map(function(d) {
                    return '<li class="doc-item"><div class="doc-info"><h4>' + escapeHtml(d.filename) + '</h4><span>ID: ' + d.id + ' | Chunks: ' + (d.chunk_count || 0) + ' | <span class="status-badge status-' + d.status + '">' + d.status + '</span></span></div><div class="doc-actions"><button class="btn-danger btn-sm" onclick="deleteDocument(\'' + d.id + '\')">Delete</button></div></li>';
                }).join('');
            } catch (e) { console.error(e); }
        }

        async function uploadFiles(files) {
            if (!files || files.length === 0) return;
            var status = document.getElementById('uploadStatus');
            var fileCount = files.length;
            if (fileCount > 10) { status.innerHTML = '<p class="error">Maximum 10 files at once</p>'; return; }
            status.innerHTML = '<p style="color: var(--p-text-sec);"><span class="spinner"></span> Uploading ' + fileCount + ' file(s)...</p>';

            if (fileCount > 1) {
                var formData = new FormData();
                for (var i = 0; i < files.length; i++) { formData.append('files', files[i]); }
                try {
                    var response = await fetch(API_URL + '/api/portal/documents/upload-batch', {
                        method: 'POST', headers: { 'Authorization': 'Bearer ' + apiKey }, body: formData
                    });
                    var data = await response.json();
                    if (!response.ok) throw new Error(data.detail || 'Upload failed');
                    var uploadedDocs = data.results.filter(function(r) { return r.status === 'success' && r.id; });
                    if (uploadedDocs.length > 0) {
                        status.innerHTML = '<p style="color: var(--p-text-sec);"><span class="spinner"></span> Processing ' + uploadedDocs.length + ' document(s)...</p>';
                        await pollDocumentsStatus(uploadedDocs.map(function(d) { return {id: d.id, filename: d.filename}; }), status);
                    }
                    if (uploadedDocs.length > 0) {
                        await assignDocsToWidget(uploadedDocs.map(function(d) { return d.id; }));
                    }
                    var failedResults = data.results.filter(function(r) { return r.status === 'failed'; });
                    if (failedResults.length > 0) {
                        var html = status.innerHTML;
                        html += '<ul style="color: var(--p-danger); font-size: 14px; margin-top: 8px; padding-left: 20px;">';
                        failedResults.forEach(function(r) { html += '<li>' + escapeHtml(r.filename) + ': ' + escapeHtml(r.error) + '</li>'; });
                        html += '</ul>';
                        status.innerHTML = html;
                    }
                    loadDocuments(); loadDashboard();
                } catch (e) { status.innerHTML = '<p class="error">Error: ' + e.message + '</p>'; }
            } else {
                var file = files[0];
                var formData2 = new FormData();
                formData2.append('file', file);
                try {
                    var response2 = await fetch(API_URL + '/api/portal/documents/upload', {
                        method: 'POST', headers: { 'Authorization': 'Bearer ' + apiKey }, body: formData2
                    });
                    var data2 = await response2.json();
                    if (!response2.ok) throw new Error(data2.detail || 'Upload failed');
                    var list = document.getElementById('docList');
                    var emptyMsg = list.querySelector('.doc-item');
                    if (emptyMsg && emptyMsg.textContent.includes('No documents yet')) list.innerHTML = '';
                    list.insertAdjacentHTML('afterbegin', '<li class="doc-item" id="doc-' + data2.id + '"><div class="doc-info"><h4>' + escapeHtml(data2.filename) + '</h4><span>ID: ' + data2.id + ' | <span class="status-badge status-processing">processing</span></span></div><div class="doc-actions"><button class="btn-danger btn-sm" disabled>Delete</button></div></li>');
                    status.innerHTML = '<p style="color: var(--p-text-sec);"><span class="spinner"></span> Processing: ' + escapeHtml(data2.filename) + '...</p>';
                    await pollDocumentStatus(data2.id, data2.filename, status);
                    await assignDocsToWidget([data2.id]);
                    loadDocuments(); loadDashboard();
                } catch (e) { status.innerHTML = '<p class="error">Error: ' + e.message + '</p>'; }
            }
            document.getElementById('fileInput').value = '';
        }

        async function pollDocumentStatus(docId, filename, statusEl) {
            var maxAttempts = 120;
            for (var i = 0; i < maxAttempts; i++) {
                try {
                    var response = await fetch(API_URL + '/api/portal/documents/' + docId + '/status', { headers: { 'Authorization': 'Bearer ' + apiKey } });
                    if (!response.ok) continue;
                    var data = await response.json();
                    if (data.status === 'ready') { statusEl.innerHTML = '<p class="success">Processed: ' + escapeHtml(filename) + ' (' + data.chunk_count + ' chunks)</p>'; return; }
                    if (data.status === 'failed') { statusEl.innerHTML = '<p class="error">Processing failed: ' + escapeHtml(filename) + '</p>'; return; }
                    statusEl.innerHTML = '<p style="color: var(--p-text-sec);"><span class="spinner"></span> Processing: ' + escapeHtml(filename) + '... (' + (i + 1) + 's)</p>';
                } catch (e) { console.error('Polling error:', e); }
                await new Promise(function(resolve) { setTimeout(resolve, 1000); });
            }
            statusEl.innerHTML = '<p style="color: var(--p-warning);">Processing in background: ' + escapeHtml(filename) + '. Refresh page to see status.</p>';
        }

        async function pollDocumentsStatus(docs, statusEl) {
            var maxAttempts = 120;
            var pending = new Set(docs.map(function(d) { return d.id; }));
            var results = {};
            for (var i = 0; i < maxAttempts && pending.size > 0; i++) {
                for (var j = 0; j < docs.length; j++) {
                    var doc = docs[j];
                    if (!pending.has(doc.id)) continue;
                    try {
                        var response = await fetch(API_URL + '/api/portal/documents/' + doc.id + '/status', { headers: { 'Authorization': 'Bearer ' + apiKey } });
                        if (!response.ok) continue;
                        var data = await response.json();
                        if (data.status === 'ready' || data.status === 'failed') { pending.delete(doc.id); results[doc.id] = data; }
                    } catch (e) { console.error('Polling error:', e); }
                }
                if (pending.size > 0) {
                    statusEl.innerHTML = '<p style="color: var(--p-text-sec);"><span class="spinner"></span> Processing ' + pending.size + ' of ' + docs.length + ' document(s)... (' + (i + 1) + 's)</p>';
                    await new Promise(function(resolve) { setTimeout(resolve, 1000); });
                }
            }
            var successCount = 0;
            docs.forEach(function(doc) { if (results[doc.id] && results[doc.id].status === 'ready') successCount++; });
            statusEl.innerHTML = '<p class="success">Processed ' + successCount + ' of ' + docs.length + ' documents</p>';
        }

        async function scrapeUrl() {
            var url = document.getElementById('scrapeUrl').value;
            var scrapeType = document.getElementById('scrapeType').value;
            var status = document.getElementById('scrapeStatus');
            if (!url) return;
            status.innerHTML = '<p style="color: var(--p-text-sec);"><span class="spinner"></span> Scraping...</p>';
            try {
                var response = await fetch(API_URL + '/api/portal/documents/scrape', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + apiKey, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: url, scrape_type: scrapeType, max_pages: 10 })
                });
                var data = await response.json();
                if (!response.ok) throw new Error(data.detail || 'Scraping failed');
                var scrapedDocIds = (data.documents || []).map(function(d) { return d.document_id; }).filter(Boolean);
                if (scrapedDocIds.length > 0) await assignDocsToWidget(scrapedDocIds);
                status.innerHTML = '<p class="success">Scraped ' + data.pages_processed + ' pages</p>';
                document.getElementById('scrapeUrl').value = '';
                showToast('Scraped ' + data.pages_processed + ' pages', 'success');
                loadDocuments(); loadDashboard();
            } catch (e) { status.innerHTML = '<p class="error">Error: ' + e.message + '</p>'; }
        }

        async function deleteDocument(docId) {
            if (!confirm('Delete this document and all its chunks?')) return;
            var docItems = document.querySelectorAll('#docList .doc-item');
            docItems.forEach(function(item) {
                if (item.innerHTML.includes(docId)) {
                    item.style.opacity = '0.3'; item.style.pointerEvents = 'none';
                    var btn = item.querySelector('.btn-danger');
                    if (btn) btn.textContent = 'Deleting...';
                }
            });
            try {
                var response = await fetch(API_URL + '/api/portal/documents/' + docId, {
                    method: 'DELETE', headers: { 'Authorization': 'Bearer ' + apiKey }
                });
                if (!response.ok) { var err = await response.json().catch(function() { return {}; }); throw new Error(err.detail || 'Delete failed (' + response.status + ')'); }
                docItems.forEach(function(item) { if (item.innerHTML.includes(docId)) item.remove(); });
                var remaining = document.querySelectorAll('#docList .doc-item');
                if (remaining.length === 0) document.getElementById('docList').innerHTML = '<li class="doc-item" style="justify-content: center; color: var(--p-text-muted);">No documents yet. Upload files or scrape websites above.</li>';
                showToast('Document deleted', 'success');
                loadDashboard();
            } catch (e) {
                docItems.forEach(function(item) {
                    if (item.innerHTML.includes(docId)) {
                        item.style.opacity = '1'; item.style.pointerEvents = 'auto';
                        var btn = item.querySelector('.btn-danger');
                        if (btn) btn.textContent = 'Delete';
                    }
                });
                showToast('Delete failed: ' + e.message, 'error');
            }
        }

        function showCreateWidgetModal() {
            document.getElementById('systemPrompt').value = DEFAULT_GUARDRAILS;
            document.getElementById('createWidgetModal').classList.add('active');
        }

        async function createWidget(event) {
            event.preventDefault();
            var data = {
                name: document.getElementById('widgetName').value,
                chatbot_name: document.getElementById('chatbotName').value,
                welcome_message: document.getElementById('welcomeMessage').value,
                system_prompt: document.getElementById('systemPrompt').value,
                model: document.getElementById('widgetModel').value,
                widget_color: document.getElementById('widgetColor').value,
                require_jwt: false
            };
            try {
                var response = await fetch(API_URL + '/api/portal/widgets', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + apiKey, 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (!response.ok) { var err = await response.json(); throw new Error(err.detail); }
                closeModal('createWidgetModal');
                showToast('Widget created!', 'success');
                loadWidgets(); loadDashboard();
            } catch (e) { showToast('Create failed: ' + e.message, 'error'); }
        }

        async function showEditWidgetModal(widgetId) {
            try {
                var response = await fetch(API_URL + '/api/portal/widgets/' + widgetId, { headers: { 'Authorization': 'Bearer ' + apiKey } });
                var w = await response.json();
                document.getElementById('editWidgetId').value = w.id;
                document.getElementById('editWidgetName').value = w.name;
                document.getElementById('editChatbotName').value = w.chatbot_name;
                document.getElementById('editWelcomeMessage').value = w.welcome_message;
                document.getElementById('editSystemPrompt').value = w.system_prompt || '';
                document.getElementById('editWidgetModel').value = w.model || 'gemini-3-flash-preview';
                document.getElementById('editWidgetColor').value = w.widget_color;
                var assignedIds = new Set(w.document_ids || []);
                var picker = document.getElementById('editDocumentPicker');
                try {
                    var docsResp = await fetch(API_URL + '/api/portal/documents', { headers: { 'Authorization': 'Bearer ' + apiKey } });
                    var docsData = await docsResp.json();
                    var docs = docsData.documents || [];
                    if (docs.length === 0) {
                        picker.innerHTML = '<p style="color: var(--p-text-muted); font-size: 13px; padding: 4px;">No documents uploaded yet.</p>';
                    } else {
                        picker.innerHTML = docs.filter(function(d) { return d.status === 'ready'; }).map(function(d) {
                            return '<label style="display: flex; align-items: center; gap: 8px; padding: 6px 4px; cursor: pointer; border-bottom: 1px solid var(--p-border);"><input type="checkbox" class="doc-checkbox" value="' + d.id + '" ' + (assignedIds.has(d.id) ? 'checked' : '') + '><span style="font-size: 14px;">' + escapeHtml(d.filename) + '</span><span style="font-size: 11px; color: var(--p-text-muted); margin-left: auto;">' + (d.chunk_count || 0) + ' chunks</span></label>';
                        }).join('');
                    }
                } catch (e2) { picker.innerHTML = '<p style="color: var(--p-danger); font-size: 13px;">Failed to load documents.</p>'; }
                document.getElementById('editDocumentIds').value = (w.document_ids || []).join(',');
                document.getElementById('editWidgetModal').classList.add('active');
            } catch (e) { showToast('Failed to load widget', 'error'); }
        }

        async function saveWidget(event) {
            event.preventDefault();
            var widgetId = document.getElementById('editWidgetId').value;
            var checkedDocs = document.querySelectorAll('#editDocumentPicker .doc-checkbox:checked');
            var selectedDocIds = Array.from(checkedDocs).map(function(cb) { return cb.value; });
            var data = {
                name: document.getElementById('editWidgetName').value,
                chatbot_name: document.getElementById('editChatbotName').value,
                welcome_message: document.getElementById('editWelcomeMessage').value,
                system_prompt: document.getElementById('editSystemPrompt').value,
                model: document.getElementById('editWidgetModel').value,
                widget_color: document.getElementById('editWidgetColor').value,
                document_ids: selectedDocIds
            };
            try {
                var response = await fetch(API_URL + '/api/portal/widgets/' + widgetId, {
                    method: 'PATCH',
                    headers: { 'Authorization': 'Bearer ' + apiKey, 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (!response.ok) { var err = await response.json(); throw new Error(err.detail); }
                closeModal('editWidgetModal');
                showToast('Widget saved!', 'success');
                loadWidgets();
            } catch (e) { showToast('Save failed: ' + e.message, 'error'); }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function escapeHtml(text) {
            if (!text) return '';
            var div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function renderMarkdown(text) {
            if (!text) return '';
            var html = escapeHtml(text);
            html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
            html = html.replace(/^### (.+)$/gm, '<h4>$1</h4>');
            html = html.replace(/^## (.+)$/gm, '<h3>$1</h3>');
            html = html.replace(/^# (.+)$/gm, '<h2>$1</h2>');
            html = html.replace(/^- (.+)$/gm, '<li>$1</li>');
            html = html.replace(/^\d+\.\s+(.+)$/gm, '<li>$1</li>');
            html = html.replace(/((?:<li>.*<\/li>\n?)+)/g, '<ul>$1</ul>');
            html = html.replace(/\n/g, '<br>');
            html = html.replace(/<br><ul>/g, '<ul>');
            html = html.replace(/<\/ul><br>/g, '</ul>');
            html = html.replace(/<\/li><br><li>/g, '</li><li>');
            return html;
        }

        // Close modal on outside click
        document.querySelectorAll('.modal').forEach(function(modal) {
            modal.addEventListener('click', function(e) { if (e.target === this) closeModal(this.id); });
        });

        // ESC key closes modals
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal.active').forEach(function(m) { closeModal(m.id); });
            }
        });

        // Drag and drop
        var uploadZone = document.getElementById('uploadZone');
        if (uploadZone) {
            uploadZone.addEventListener('dragover', function(e) { e.preventDefault(); uploadZone.classList.add('dragover'); });
            uploadZone.addEventListener('dragleave', function() { uploadZone.classList.remove('dragover'); });
            uploadZone.addEventListener('drop', function(e) {
                e.preventDefault(); uploadZone.classList.remove('dragover');
                if (e.dataTransfer.files.length) uploadFiles(e.dataTransfer.files);
            });
        }
    </script>
</body>
</html>
